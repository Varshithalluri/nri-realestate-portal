<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard — NRI Real Estate Portal</title>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            background: #f1f3f6;
            color: #0f172a
        }

        .page {
            max-width: 1200px;
            margin: 28px auto;
            padding: 0 18px
        }

        header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 14px
        }

        .title-area {
            display: flex;
            flex-direction: column
        }

        h1 {
            margin: 0;
            font-size: 22px
        }

        .subtitle {
            color: #6b7280;
            font-size: 13px;
            margin-top: 6px
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center
        }

        .btn {
            background: #2563eb;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            cursor: pointer;
            font-size: 14px
        }

        .btn.gray {
            background: #f3f6fb;
            color: #1f2937;
            border: 1px solid #e6edf5
        }

        .muted {
            color: #6b7280;
            font-size: 13px
        }

        /* big centered panel like your screenshot */
        .panel {
            background: #fff;
            border-radius: 10px;
            padding: 14px 18px;
            box-shadow: 0 8px 30px rgba(8, 12, 20, 0.06);
            border: 1px solid #eef2f7
        }

        .status {
            margin-bottom: 12px;
            color: #374151
        }

        /* grid of cards 2 columns */
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px
        }

        @media(max-width:920px) {
            .grid {
                grid-template-columns: repeat(1, 1fr)
            }
        }

        .card {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eef2f7;
            display: flex;
            flex-direction: column
        }

        .card .media {
            height: 150px;
            background: #f2f6fb;
            overflow: hidden
        }

        .card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block
        }

        .card .body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .card .title {
            font-weight: 700;
            font-size: 18px;
            margin: 0
        }

        .card .meta {
            color: #6b7280;
            font-size: 13px
        }

        .card .smallmeta {
            color: #475569;
            font-size: 13px
        }

        .actions {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 6px
        }

        .actions .btn.small {
            padding: 6px 10px;
            font-size: 13px
        }

        .btn.delete {
            background: #ef4444
        }

        .owner {
            color: #475569;
            font-size: 13px;
            margin-top: 8px
        }

        /* modals */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(8, 10, 12, 0.45);
            z-index: 1200;
            padding: 20px
        }

        .modal {
            background: #fff;
            border-radius: 10px;
            padding: 16px;
            max-width: 520px;
            width: 100%;
            max-height: calc(100vh - 80px);
            overflow: auto;
            position: relative;
            box-shadow: 0 18px 60px rgba(8, 12, 20, 0.25)
        }

        .modal h3 {
            margin: 0 0 8px 0
        }

        .close {
            position: absolute;
            right: 12px;
            top: 10px;
            background: transparent;
            border: 0;
            font-size: 18px;
            cursor: pointer
        }

        label {
            display: block;
            margin-top: 8px;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: #111827
        }

        input[type="text"],
        input[type="number"],
        textarea,
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e6edf5;
            font-size: 14px;
            background: #fff
        }

        textarea {
            min-height: 70px;
            resize: vertical
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px
        }

        /* small helpers */
        .right {
            margin-left: auto;
        }
    </style>
</head>

<body>
    <div class="page">
        <header>
            <div class="title-area">
                <h1>Dashboard</h1>
                <div class="subtitle">Browse and manage property listings</div>
            </div>

            <div class="header-actions">
                <button id="openAddBtn" class="btn">Add Property</button>
            </div>
        </header>

        <div class="panel">
            <div id="status" class="status muted">Loading…</div>

            <div id="gridWrap">
                <div id="grid" class="grid" aria-live="polite"></div>
            </div>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div id="addModal" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true">
            <button id="addClose" class="close" title="Close">✕</button>
            <h3>Add Property</h3>
            <form id="addForm" enctype="multipart/form-data">
                <label for="title">Title</label>
                <input id="title" name="title" type="text" required />

                <label for="city">City</label>
                <input id="city" name="city" type="text" />

                <label for="price">Price</label>
                <input id="price" name="price" type="number" />

                <label for="description">Description</label>
                <textarea id="description" name="description" rows="3"></textarea>

                <label for="photos">Photos (required)</label>
                <input id="photos" name="photos" type="file" accept="image/*" multiple required />

                <div class="modal-actions">
                    <button type="button" id="addCancel" class="btn gray">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
                <div id="addStatus" class="muted" style="margin-top:8px"></div>
            </form>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal-backdrop">
        <div class="modal" role="dialog" aria-modal="true">
            <button id="contactClose" class="close" title="Close">✕</button>
            <h3>Contact Owner</h3>
            <div id="contactMsg" class="muted">Fetching contact…</div>
            <div id="contactPhone" style="margin-top:12px;font-weight:700;font-size:16px"></div>
            <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
                <button id="contactCall" class="btn" style="display:none">Call</button>
                <button id="contactCloseBtn" class="btn gray">Close</button>
            </div>
        </div>
    </div>

    <script>
        let PROPERTIES = [];
        let currentUser = null;

        const statusEl = document.getElementById('status');
        const gridEl = document.getElementById('grid');

        const openAddBtn = document.getElementById('openAddBtn');
        const addModal = document.getElementById('addModal');
        const addClose = document.getElementById('addClose');
        const addCancel = document.getElementById('addCancel');
        const addForm = document.getElementById('addForm');
        const addStatus = document.getElementById('addStatus');

        const contactModal = document.getElementById('contactModal');
        const contactClose = document.getElementById('contactClose');
        const contactCloseBtn = document.getElementById('contactCloseBtn');
        const contactMsg = document.getElementById('contactMsg');
        const contactPhone = document.getElementById('contactPhone');
        const contactCall = document.getElementById('contactCall');

        function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }

        function parsePhotos(val) {
            if (!val) return [];
            if (Array.isArray(val)) return val;
            if (typeof val === 'string') {
                try { const p = JSON.parse(val); return Array.isArray(p) ? p : [val]; } catch (e) { return [val]; }
            }
            return [];
        }

        async function loadMe() {
            try {
                const r = await fetch('/api/me', { credentials: 'include' });
                const j = await r.json();
                currentUser = j.user || null;
            } catch (e) {
                console.error('loadMe error', e);
                currentUser = null;
            }
        }

        async function loadProperties() {
            statusEl.textContent = 'Loading properties…';
            try {
                const r = await fetch('/api/properties');
                if (!r.ok) throw new Error('Failed to load properties');
                const j = await r.json();
                PROPERTIES = j.properties || [];
                renderProperties();
                statusEl.textContent = `Loaded ${PROPERTIES.length} listings`;
            } catch (e) {
                console.error('loadProperties error', e);
                statusEl.textContent = 'Error loading properties';
                PROPERTIES = [];
                renderProperties();
            }
        }

        function renderProperties() {
            gridEl.innerHTML = '';
            if (!PROPERTIES || PROPERTIES.length === 0) {
                const no = document.createElement('div');
                no.textContent = 'No listings yet.';
                no.className = 'muted';
                gridEl.appendChild(no);
                return;
            }

            PROPERTIES.forEach(p => {
                const card = document.createElement('div');
                card.className = 'card';

                const media = document.createElement('div');
                media.className = 'media';
                const img = document.createElement('img');
                const photos = parsePhotos(p.photos);
                img.src = p.preview_url || (photos.length ? photos[0] : '/uploads/placeholder.png');
                img.alt = p.title || 'property';
                media.appendChild(img);

                const body = document.createElement('div');
                body.className = 'body';

                const title = document.createElement('div');
                title.className = 'title';
                title.textContent = p.title || '';

                const meta = document.createElement('div');
                meta.className = 'meta';
                meta.textContent = `${p.city || ''} · ₹${p.price || ''}`;

                const smallmeta = document.createElement('div');
                smallmeta.className = 'smallmeta';
                if (p.property_type) smallmeta.textContent = p.property_type;

                const actions = document.createElement('div');
                actions.className = 'actions';

                const buyBtn = document.createElement('button');
                buyBtn.className = 'btn small';
                buyBtn.textContent = 'Buy';
                buyBtn.onclick = () => openContactModal(p.property_id);
                actions.appendChild(buyBtn);

                if (currentUser && p.owner_id === currentUser.user_id) {
                    const editLink = document.createElement('a');
                    editLink.className = 'btn small gray';
                    editLink.textContent = 'Edit';
                    editLink.href = '/edit_property.html?id=' + encodeURIComponent(p.property_id);
                    actions.appendChild(editLink);

                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn small delete';
                    delBtn.textContent = 'Delete';
                    delBtn.onclick = () => deleteProperty(p.property_id);
                    actions.appendChild(delBtn);
                }

                const owner = document.createElement('div');
                owner.className = 'owner';
                owner.textContent = 'Owner: ' + (p.owner_name || '—');

                body.appendChild(title);
                body.appendChild(meta);
                if (smallmeta.textContent) body.appendChild(smallmeta);
                body.appendChild(actions);
                body.appendChild(owner);

                card.appendChild(media);
                card.appendChild(body);
                gridEl.appendChild(card);
            });
        }

        function openContactModal(propertyId) {
            contactMsg.textContent = 'Fetching contact…';
            contactPhone.textContent = '';
            contactCall.style.display = 'none';
            contactModal.style.display = 'flex';

            fetch('/api/property/' + encodeURIComponent(propertyId) + '/contact', { credentials: 'include' })
                .then(async res => {
                    if (!res.ok) {
                        if (res.status === 401) contactMsg.textContent = 'Please login to view contact.';
                        else if (res.status === 404) contactMsg.textContent = 'Property not found.';
                        else contactMsg.textContent = 'Could not fetch contact.';
                        return;
                    }
                    const j = await res.json();
                    const phone = j.phone || 'No phone provided';
                    contactMsg.textContent = '';
                    contactPhone.textContent = phone;
                    if (phone && phone !== 'No phone provided' && phone.trim() !== '') {
                        contactCall.style.display = 'inline-block';
                        contactCall.onclick = () => { location.href = 'tel:' + phone.replace(/\s+/g, ''); };
                    } else {
                        contactCall.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('contact fetch error', err);
                    contactMsg.textContent = 'Error fetching contact.';
                });
        }

        function closeContactModal() {
            contactModal.style.display = 'none';
            contactMsg.textContent = '';
            contactPhone.textContent = '';
            contactCall.style.display = 'none';
        }

        contactClose.addEventListener('click', closeContactModal);
        contactCloseBtn.addEventListener('click', closeContactModal);

        async function deleteProperty(id) {
            if (!confirm('Delete this listing? This will also remove uploaded images.')) return;
            try {
                const r = await fetch('/api/property/' + encodeURIComponent(id), { method: 'DELETE', credentials: 'include' });
                const j = await r.json();
                if (r.ok && j.success) {
                    alert('Deleted');
                    await loadProperties();
                } else {
                    alert(j.error || 'Delete failed');
                }
            } catch (err) {
                console.error('delete error', err);
                alert('Delete error');
            }
        }

        function openAddModal() { addModal.style.display = 'flex'; addStatus.textContent = ''; addForm.reset(); }
        function closeAddModal() { addModal.style.display = 'none'; addStatus.textContent = ''; addForm.reset(); }
        openAddBtn.addEventListener('click', openAddModal);
        addClose.addEventListener('click', closeAddModal);
        addCancel.addEventListener('click', closeAddModal);

        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addStatus.textContent = 'Uploading...';
            const files = document.getElementById('photos').files;
            if (!files || files.length === 0) { addStatus.textContent = 'Please select at least one photo'; return; }
            const fd = new FormData(addForm);
            try {
                const res = await fetch('/api/properties/add', {
                    method: 'POST',
                    body: fd,
                    credentials: 'include'
                });
                const j = await res.json();
                if (res.ok && j.success) {
                    addStatus.textContent = 'Saved';
                    await loadProperties();
                    setTimeout(closeAddModal, 400);
                } else {
                    addStatus.textContent = j.error || 'Save failed';
                    console.error('add error', j);
                }
            } catch (err) {
                console.error('add exception', err);
                addStatus.textContent = 'Upload failed';
            }
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (addModal.style.display === 'flex') closeAddModal();
                if (contactModal.style.display === 'flex') closeContactModal();
            }
        });

        (async function init() {
            await loadMe();
            await loadProperties();
        })();
    </script>
</body>

</html>